# Manual Testing Guide for `task-management` Edge Function

This guide provides steps to manually test the `task-management` Supabase edge function after recent modifications.

## 1. Prerequisites

Before testing, ensure the following are set up in your Supabase project:

### 1.1. `integration_keys` Table

*   Create a table named `integration_keys` with at least the following columns:
    *   `key` (Type: `TEXT` or `VARCHAR`, Unique): Stores the integration key string.
    *   `user_id` (Type: `UUID`, Foreign Key to `auth.users(id)`): The Supabase user ID this key is associated with.
    *   `is_active` (Type: `BOOLEAN`): Whether the key is currently active.
    *   `description` (Type: `TEXT`, Optional): A description for the key.

*   **Sample Data**:
    *   **Valid & Active Key**: Insert a row for a user that exists in your `auth.users` table.
        *   `key`: `test-integration-key-active`
        *   `user_id`: (UUID of an existing user, e.g., `12345678-1234-1234-1234-1234567890ab`)
        *   `is_active`: `true`
        *   `description`: "Active key for testing"
    *   **Valid & Inactive Key**: Insert another row.
        *   `key`: `test-integration-key-inactive`
        *   `user_id`: (Same or different UUID of an existing user)
        *   `is_active`: `false`
        *   `description`: "Inactive key for testing"

### 1.2. `tasks` Table

*   Ensure you have a `tasks` table. The function attempts to insert into this table.
*   It should have at least these columns:
    *   `title` (Type: `TEXT` or `VARCHAR`)
    *   `description` (Type: `TEXT`, Optional)
    *   `estimated_minute` (Type: `INTEGER`, Optional)
    *   `task_date` (Type: `DATE`, Optional)
    *   `user_id` (Type: `UUID`): This will store the `user_id` associated with the integration key.

### 1.3. RLS (Row Level Security) on `tasks` Table

*   For the RLS test, ensure RLS is enabled for the `tasks` table.
*   Create a policy that restricts access based on `user_id`. A common policy would be:
    ```sql
    ALTER TABLE tasks ENABLE ROW LEVEL SECURITY;

    CREATE POLICY "Users can manage their own tasks"
    ON tasks
    FOR ALL
    USING (auth.uid() = user_id)
    WITH CHECK (auth.uid() = user_id);
    ```
    *Note: This policy assumes `auth.uid()` will correctly resolve to the `user_id` set in the JWT generated by the function.*

### 1.4. Environment Variables for the Edge Function

Ensure the following environment variables are set for your `task-management` Supabase function (either locally via `.env` file if using `supabase start`, or in the Supabase project settings):

*   `SUPABASE_URL`: Your project's Supabase URL.
*   `SUPABASE_ANON_KEY`: Your project's anon key.
*   `SUPABASE_SERVICE_ROLE_KEY`: Your project's service role key.
*   `SUPABASE_JWT_SECRET`: A strong secret string used to sign the JWTs. This **must** be the same secret your Supabase project uses for its JWT verification. You can find this in your Supabase project's JWT settings.

## 2. Testing Scenarios

Use a tool like `curl` or Postman to make requests to the edge function. The default local URL is `http://127.0.0.1:54321/functions/v1/task-management`.

### 2.1. Success Case

*   **Action**: Call the function with a valid `x-integration-id` (that is active) and valid JSON task data.
    ```bash
    curl -i --location --request POST 'http://127.0.0.1:54321/functions/v1/task-management' \
    --header 'x-integration-id: test-integration-key-active' \
    --header 'Content-Type: application/json' \
    --data '{
        "title": "My Test Task via Integration",
        "description": "This is a task created successfully.",
        "estimated_minute": 60
    }'
    ```
*   **Expected Outcome**:
    *   HTTP Status Code: `200 OK` (or `201 Created` if you've customized it, but the current code returns 200).
    *   Response Body: JSON similar to `{"message":"タスクが正常に作成されました","task":{...}}` where `task` contains the created task data, including its `id` and the correct `user_id`.
*   **Verification**:
    *   Check the `tasks` table in your Supabase project.
    *   A new task should be created with the details provided.
    *   The `user_id` of the new task **must** match the `user_id` associated with `test-integration-key-active` in your `integration_keys` table.

### 2.2. Error Cases

#### 2.2.1. Missing `x-integration-id` Header

*   **Action**: Call the function without the `x-integration-id` header.
    ```bash
    curl -i --location --request POST 'http://127.0.0.1:54321/functions/v1/task-management' \
    --header 'Content-Type: application/json' \
    --data '{"title":"Task missing header"}'
    ```
*   **Expected Outcome**:
    *   HTTP Status Code: `400 Bad Request`.
    *   Response Body: `{"error":"x-integration-id header is missing"}`.

#### 2.2.2. Non-existent `x-integration-id`

*   **Action**: Call the function with an `x-integration-id` that is not in the `integration_keys` table.
    ```bash
    curl -i --location --request POST 'http://127.0.0.1:54321/functions/v1/task-management' \
    --header 'x-integration-id: non-existent-key' \
    --header 'Content-Type: application/json' \
    --data '{"title":"Task with non-existent key"}'
    ```
*   **Expected Outcome**:
    *   HTTP Status Code: `404 Not Found`.
    *   Response Body: `{"error":"Integration key not found."}`.

#### 2.2.3. Inactive `x-integration-id`

*   **Action**: Call the function with an `x-integration-id` that is marked `is_active = false`.
    ```bash
    curl -i --location --request POST 'http://127.0.0.1:54321/functions/v1/task-management' \
    --header 'x-integration-id: test-integration-key-inactive' \
    --header 'Content-Type: application/json' \
    --data '{"title":"Task with inactive key"}'
    ```
*   **Expected Outcome**:
    *   HTTP Status Code: `403 Forbidden`.
    *   Response Body: `{"error":"Integration key is inactive."}`.

#### 2.2.4. Invalid Task Data

*   **Action**: Call the function with invalid task data (e.g., missing title).
    ```bash
    curl -i --location --request POST 'http://127.0.0.1:54321/functions/v1/task-management' \
    --header 'x-integration-id: test-integration-key-active' \
    --header 'Content-Type: application/json' \
    --data '{"description":"Task missing title"}'
    ```
*   **Expected Outcome**:
    *   HTTP Status Code: `400 Bad Request`.
    *   Response Body: `{"error":"Invalid task data","details":["タイトルは必須です"]}`.

#### 2.2.5. Missing Environment Variable (Conceptual)

*   **Action**: This is harder to test directly with `curl` without modifying the function's deployment environment. If you were to temporarily unset `SUPABASE_JWT_SECRET` (or any of the other required env vars like `SUPABASE_URL`, `SUPABASE_ANON_KEY`, `SUPABASE_SERVICE_ROLE_KEY`) for the function and then call it:
    ```bash
    # Assuming SUPABASE_JWT_SECRET is unset for the function's environment
    curl -i --location --request POST 'http://127.0.0.1:54321/functions/v1/task-management' \
    --header 'x-integration-id: test-integration-key-active' \
    --header 'Content-Type: application/json' \
    --data '{"title":"Test Env Var Missing"}'
    ```
*   **Expected Outcome**:
    *   HTTP Status Code: `500 Internal Server Error`.
    *   Response Body: `{"error":"Server configuration error."}`.
    *   Server-side logs for the function should indicate which variable was missing (e.g., "Missing one or more required environment variables...").

### 2.3. RLS Test (Conceptual & Practical)

This tests if the JWT generated by the function correctly assumes the `user_id` for RLS policies on the `tasks` table.

*   **Prerequisite**: Ensure RLS policy from section 1.3 is active.

*   **Scenario 1: Task `user_id` matches JWT `sub` (Implicit)**
    *   This is covered by the **Success Case (2.1)**. The `newTask` object in the function uses `user_id: taskData.user_id || actualUserId`. If `taskData.user_id` is NOT provided in the request body, `actualUserId` (from the integration key) is used. The JWT's `sub` claim is set to this `actualUserId`. RLS should allow the insert because `auth.uid()` (derived from the JWT `sub`) will match `newTask.user_id`.

*   **Scenario 2: Attempt to set `taskData.user_id` to a different user (if allowed by function logic)**
    *   The current function logic: `user_id: taskData.user_id || actualUserId`. This means if `taskData.user_id` *is* provided in the request, it will take precedence *before* being inserted. The JWT, however, will still be generated for `actualUserId` (the one from the integration key).
    *   **Action**: Send a request where `taskData.user_id` is a valid UUID of a *different* user than the one associated with `test-integration-key-active`.
        ```bash
        # Assume 'other-user-uuid' is a valid UUID of a user who is NOT associated with 'test-integration-key-active'
        curl -i --location --request POST 'http://127.0.0.1:54321/functions/v1/task-management' \
        --header 'x-integration-id: test-integration-key-active' \
        --header 'Content-Type: application/json' \
        --data '{
            "title": "RLS Test Task - Mismatched UserID",
            "user_id": "other-user-uuid" 
        }'
        ```
    *   **Expected Outcome**:
        *   HTTP Status Code: `400 Bad Request` (This is what the current code returns on Supabase insert errors, which an RLS violation would cause).
        *   Response Body: `{"error":"タスクの保存に失敗しました", "details":"..."}`. The details might contain "new row violates row-level security policy for table \"tasks\"" or similar.
    *   **Verification**:
        *   The task should NOT be created in the `tasks` table.
        *   This confirms that even if the function logic *could* try to set a different `user_id`, the RLS policy enforced by Supabase (using the JWT's `auth.uid()`) prevents it.

    *   **Note on `taskData.user_id`**: The current function allows `taskData.user_id` to be optionally passed. If the intention is that the `x-integration-id` *solely* dictates the `user_id`, then the function logic should be changed to ignore any `user_id` in `taskData` and always use `actualUserId`. The RLS policy, however, provides a strong safeguard.

## 3. Cleanup

*   Remember to remove or deactivate test data (integration keys, tasks) as needed after testing.
*   Revert any temporary changes to environment variables.
```
